<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة المدارس - تسجيل المعلمين (Cloud Edition)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Admin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
            }

            .print-container {
                padding: 0;
                margin: 0;
                width: 100%;
                direction: rtl;
            }

            .app-header,
            nav,
            button,
            form {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            .report-card {
                border: 2px solid #000;
                padding: 20px;
                margin-top: 20px;
            }

            .report-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .data-grid {
                display: grid;
                grid-template-cols: 1fr 1fr;
                gap: 15px;
            }

            .data-item {
                border-bottom: 1px dotted #ccc;
                padding: 5px 0;
            }

            .signature-area {
                margin-top: 40px;
                display: flex;
                justify-content: space-between;
            }
        }

        .print-only {
            display: none;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800 flex flex-col justify-between">

    <div id="app" class="max-w-[1400px] mx-auto p-4 w-full flex-grow transition-all duration-500">
        <!-- App Content injected here -->
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-4 z-50 flex flex-col gap-2"></div>

    <style>
        .toast-enter {
            transform: translateX(-100%);
            opacity: 0;
        }

        .toast-enter-active {
            transform: translateX(0);
            opacity: 1;
            transition: all 0.3s ease-out;
        }

        .toast-exit {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-exit-active {
            transform: translateX(-100%);
            opacity: 0;
            transition: all 0.3s ease-in;
        }
    </style>

    <!-- Professional Footer -->
    <footer class="bg-slate-900 text-slate-400 py-6 mt-12 border-t border-slate-800">
        <div
            class="max-w-[1400px] mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4 text-center md:text-right">
            <div>
                <p class="font-bold text-slate-200 text-lg">إدارة العمرانية التعليمية 2025</p>
                <p class="text-sm mt-1 italic">جميع حقوق النشر والبرمجة محفوظة © 2025</p>
            </div>

            <div class="flex flex-col items-center md:items-end">
                <span class="text-xs bg-slate-800 px-3 py-1 rounded-full border border-slate-700 mb-1">تطوير
                    وبرمجة</span>
                <span class="font-bold text-blue-400 font-mono tracking-wide text-lg">Diaa El Attar</span>
            </div>
        </div>
    </footer>

    <script>
        // --- Configuration & Constants ---

        // ⚠️ هام جداً: ضع رابط Apps Script هنا بين علامتي التنصيص ليعمل البرنامج مباشرة
        const CONFIG_API_URL = "https://script.google.com/macros/s/AKfycbwlHw2s0uE5_08BbRSrukw6CHjg7MwVZcD0HKgVnmJzqy-_S4uoFzFFcvO7IcnpaDo/exec";

        // Initial Mock Schools (Fallback until Cloud Fetch)
        let SCHOOLS_DB = [
            { code: "1001", password: "123", name: "مدرسة النور الابتدائية", stage: "Abdaey", stageName: "الابتدائية", type: "government", typeName: "حكومي عربي" },
            { code: "admin", password: "admin123", name: "General Admin", stage: "All", stageName: "الإدارة", type: "admin", typeName: "مسؤول النظام" }
        ];

        let API_URL = CONFIG_API_URL || localStorage.getItem('TEACHER_APP_API_URL') || '';
        const LOGO_URL = "https://i.ibb.co/VmmS6L8/logo-omraneya.jpg"; // رابط شعار الإدارة الاحترافي

        // --- State ---
        const state = {
            currentView: API_URL ? 'login' : 'setup', // setup | login | dashboard | admin
            user: null,
            teachers: [],
            schools: [], // Dynamic Schools List
            isLoading: false,
            adminData: [],
            editingIndex: null,
            editingSchool: false,
            loginForm: { stage: '', type: '', school: '', password: '' },
            tempFormData: {}, // For teacher registration persistence
            teacherLoginMode: false, // Toggle between School and Teacher login
            regFormStage: '' // For teacher self-registration stage filtering
        };

        const app = document.getElementById('app');

        // --- Core Helpers & Utilities (Moved up for stability) ---
        function setState(key, val) { state[key] = val; render(); }
        function handleFormChange(name, val) { state.tempFormData[name] = val; }
        function toggleElement(id) { const el = document.getElementById(id); if (el) el.classList.toggle('hidden'); }
        function logout() { state.user = null; state.currentView = 'login'; state.regFormStage = ''; state.loginForm = { stage: '', type: '', school: '', password: '' }; render(); }
        function clearConfig() { localStorage.removeItem('TEACHER_APP_API_URL'); location.reload(); }

        // --- Toast Notification System ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { success: 'bg-green-100 border-green-500 text-green-700', error: 'bg-red-100 border-red-500 text-red-700', info: 'bg-blue-100 border-blue-500 text-blue-700', warning: 'bg-yellow-100 border-yellow-500 text-yellow-700' };
            const icons = { success: 'check-circle', error: 'alert-circle', info: 'info', warning: 'alert-triangle' };
            toast.className = `${colors[type]} border-l-4 p-4 rounded shadow-lg flex items-center gap-3 min-w-[300px] max-w-md toast-enter`;
            toast.innerHTML = `<i data-lucide="${icons[type]}" class="w-6 h-6"></i><div><p class="font-bold text-sm">${type === 'success' ? 'نجاح' : (type === 'error' ? 'خطأ' : 'تنبيه')}</p><p class="text-xs">${message}</p></div>`;
            container.appendChild(toast);
            lucide.createIcons();
            requestAnimationFrame(() => { toast.classList.remove('toast-enter'); toast.classList.add('toast-enter-active'); });
            setTimeout(() => { toast.classList.remove('toast-enter-active'); toast.classList.add('toast-exit-active'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function renderLoading() {
            app.innerHTML = `
                <div class="flex flex-col items-center justify-center h-[80vh]">
                    <div class="loader mb-4 border-t-yellow-500"></div>
                    <p class="text-slate-600 font-bold animate-pulse">جاري الاتصال بالنظام...</p>
                </div>
            `;
        }

        // --- API Client ---
        async function apiRequest(action, data = null) {
            if (!API_URL) return { status: 'error', message: 'API URL not configured' };
        }

        async function sendData(action, payload) {
            state.isLoading = true; render();
            try {
                // Use text/plain to avoid CORS preflight (OPTIONS) which GAS doesn't handle well
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: action, ...payload })
                });

                const res = await response.json();
                state.isLoading = false; render();
                return res;
            } catch (e) {
                state.isLoading = false; render();
                console.error('API Error:', e);
                return { status: 'error', message: 'فشل الاتصال بالسيرفر: ' + e.toString() };
            }
        }

        async function fetchData(endpoint = 'getAllTeachers') {
            state.isLoading = true; render();
            try {
                const res = await fetch(`${API_URL}?action=${endpoint}`);
                const json = await res.json();
                state.isLoading = false; render();
                return json;
            } catch (e) {
                state.isLoading = false; render();
                if (endpoint === 'getSchools') return { status: 'error', data: [] }; // silent fail
                showToast('فشل جلب البيانات. تأكد من صحة الرابط.', 'error');
                return { status: 'error', data: [] };
            }
        }


        // --- Views ---

        function renderSetup() {
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-[80vh]">
                    <div class="bg-white p-8 rounded-xl shadow-xl max-w-md w-full border border-gray-100 text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
                            <i data-lucide="cloud-cog" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-2">إعداد النظام</h2>
                        <input type="text" id="apiUrlInput" class="w-full p-3 border rounded-lg text-left text-sm font-mono mb-4 bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://script.google.com/macros/s/..../exec">
                        <button onclick="saveConfig()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">حفظ واتصال</button>
                    </div>
                </div>
            `;
        }

        async function saveConfig() {
            const url = document.getElementById('apiUrlInput').value.trim();
            if (!url || !url.includes('script.google.com')) return showToast('رابط غير صحيح', 'error');
            API_URL = url;
            localStorage.setItem('TEACHER_APP_API_URL', url);

            // Initial Load of Schools
            await reloadSchoolsAndLogin();
        }

        async function reloadSchoolsAndLogin() {
            const res = await fetchData('getSchools');
            if (res.status === 'success' && res.data.length > 0) {
                SCHOOLS_DB = res.data;
                state.schools = res.data;
                // Add Admin backdoor if missing from sheet
                if (!SCHOOLS_DB.some(s => s.code === 'admin')) {
                    const admin = { code: "admin", password: "admin123", name: "General Admin", stage: "All", stageName: "الإدارة", type: "admin", typeName: "مسؤول النظام" };
                    SCHOOLS_DB.push(admin);
                    state.schools.push(admin);
                }
            }
            state.currentView = 'login';
            render();
        }

        function renderLogin() {
            const activeStage = state.loginForm.stage;
            const activeType = state.loginForm.type;

            // Filters based on SCHOOLS_DB
            const stages = [...new Set(SCHOOLS_DB.filter(s => s.type !== 'admin').map(s => JSON.stringify({ c: s.stage, n: s.stageName })))].map(JSON.parse);
            const types = activeStage ? [...new Set(SCHOOLS_DB.filter(s => s.stage === activeStage).map(s => JSON.stringify({ c: s.type, n: s.typeName })))].map(JSON.parse) : [];
            const schools = (activeStage && activeType) ? SCHOOLS_DB.filter(s => s.stage === activeStage && s.type === activeType) : [];

            app.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[85vh]">
                    <div class="max-w-md w-full mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100 flex flex-col">
                    <div class="bg-gradient-to-br from-blue-700 to-blue-900 p-8 text-white text-center relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <div class="relative z-10 mb-4 inline-block p-3 bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 shadow-xl">
                            <img src="${LOGO_URL}" alt="Logo" class="w-16 h-16 object-contain rounded-lg shadow-sm" onerror="this.src='https://via.placeholder.com/64?text=LOGO'">
                        </div>
                        <h1 class="text-3xl font-black mb-2 tracking-tight">بوابة المعلمين</h1>
                        <p class="text-blue-100 font-medium text-sm">إدارة العمرانية التعليمية - نظام التسجيل الموحد</p>
                    </div>

                    <div class="flex border-b">
                        <button onclick="setState('teacherLoginMode', false)" class="flex-1 py-4 font-bold text-sm ${!state.teacherLoginMode ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400'}">دخول المدارس</button>
                        <button onclick="setState('teacherLoginMode', true)" class="flex-1 py-4 font-bold text-sm ${state.teacherLoginMode ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-400'}">دخول المعلمين</button>
                    </div>

                    <div class="p-8">
                        ${state.teacherLoginMode ? renderTeacherLoginFields() : renderSchoolLoginFields()}
                    </div>
                    </div>
                </div>
            `;
        }

        function renderTeacherLoginFields() {
            return `
                <div class="space-y-5 animate-fade-in">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-widest">الرقم القومي</label>
                        <div class="relative">
                            <i data-lucide="credit-card" class="absolute right-3 top-3.5 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="teacherNID" maxlength="14" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full p-3.5 pr-11 bg-gray-50 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 transition-all outline-none text-lg font-mono tracking-widest" placeholder="أدخل 14 رقماً">
                        </div>
                    </div>
                    <button onclick="handleTeacherLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 shadow-xl shadow-blue-200 transition-all active:scale-[0.98] flex items-center justify-center gap-2 mt-4">
                        <i data-lucide="log-in" class="w-5 h-5"></i> دخول / تسجيل
                    </button>
                    <p class="text-[10px] text-gray-400 text-center">أدخل رقمك القومي للدخول أو البدء في تسجيل بياناتك لأول مرة</p>
                    <button onclick="toggleAdminLogin()" class="w-full text-blue-400 text-xs mt-6 font-medium bg-blue-50 py-2 rounded-lg border border-blue-100 italic">دخول المشرف (الأدمن)</button>
                </div>
            `;
        }

        function renderSchoolLoginFields() {
            const filteredSchools = state.schools.filter(s =>
                (state.loginForm.stage ? s.stage === state.loginForm.stage : true) &&
                (state.loginForm.type ? s.type === state.loginForm.type : true) &&
                s.type !== 'admin'
            );

            return `
                <div id="schoolLoginPanel" class="space-y-5 animate-fade-in">
                    <div class="grid grid-cols-2 gap-4">
                        <select onchange="setState('loginForm', {...state.loginForm, stage: this.value, type: '', school: ''})" class="p-3 bg-gray-50 rounded-xl border border-gray-200 text-xs font-bold outline-none">
                            <option value="">كل المراحل</option>
                            ${[...new Set(state.schools.filter(s => s.type !== 'admin').map(s => s.stage))].map(stage => {
                const stageName = state.schools.find(s => s.stage === stage)?.stageName || stage;
                return `<option value="${stage}" ${state.loginForm.stage == stage ? 'selected' : ''}>${stageName}</option>`;
            }).join('')}
                        </select>
                        <select onchange="setState('loginForm', {...state.loginForm, type: this.value, school: ''})" class="p-3 bg-gray-50 rounded-xl border border-gray-200 text-xs font-bold outline-none">
                            <option value="">كل الأنواع</option>
                            ${[...new Set(state.schools.filter(s => s.type !== 'admin' && (!state.loginForm.stage || s.stage === state.loginForm.stage)).map(s => s.type))].map(type => {
                const typeName = state.schools.find(s => s.type === type)?.typeName || type;
                return `<option value="${type}" ${state.loginForm.type == type ? 'selected' : ''}>${typeName}</option>`;
            }).join('')}
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-widest">اختر المدرسة</label>
                        <select id="schoolSelect" onchange="setState('loginForm', {...state.loginForm, school: this.value})" class="w-full p-3.5 bg-gray-50 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 transition-all outline-none font-bold text-gray-700">
                            <option value="">-- اختر المدرسة --</option>
                            ${filteredSchools.map(s => `<option value="${s.code}" ${state.loginForm.school == s.code ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-widest">كلمة المرور</label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute right-3 top-3.5 w-5 h-5 text-gray-400"></i>
                            <input type="password" id="schoolPass" oninput="state.loginForm.password = this.value" value="${state.loginForm.password || ''}" class="w-full p-3.5 pr-11 bg-gray-50 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 transition-all outline-none" placeholder="••••••••">
                        </div>
                    </div>

                    <button onclick="handleSchoolLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 shadow-xl shadow-blue-200 transition-all active:scale-[0.98] flex items-center justify-center gap-2 mt-4">
                        <i data-lucide="log-in" class="w-5 h-5"></i> دخول المدرسة
                    </button>
                    
                    <div class="text-center mt-2">
                        <button onclick="reloadSchoolsAndLogin()" class="text-[10px] text-gray-400 hover:text-blue-500 underline flex items-center gap-1 mx-auto">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> تحديث قائمة المدارس
                        </button>
                    </div>

                    <button onclick="toggleAdminLogin()" class="w-full text-blue-400 text-xs mt-4 font-medium bg-blue-50 py-2 rounded-lg border border-blue-100 italic">دخول المشرف (الأدمن)</button>
                </div>

                <div id="adminLoginPanel" class="hidden space-y-4 animate-fade-in">
                    <div class="p-6 bg-red-50 rounded-2xl border border-red-100 shadow-inner">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-red-500 p-2 rounded-lg"><i data-lucide="shield-check" class="text-white w-5 h-5"></i></div>
                            <h3 class="font-bold text-red-700">دخول الإدارة</h3>
                        </div>
                        <div class="space-y-4">
                            <input type="text" id="adminUser" class="w-full p-3 rounded-xl border focus:ring-2 focus:ring-red-500" placeholder="Username">
                            <input type="password" id="adminPass" class="w-full p-3 rounded-xl border focus:ring-2 focus:ring-red-500" placeholder="Password">
                            <button onclick="handleAdminLogin()" class="w-full bg-red-600 text-white font-bold py-3.5 rounded-xl hover:bg-red-700 shadow-lg mt-4">دخول المسؤول</button>
                            <button onclick="toggleAdminLogin()" class="w-full text-gray-500 text-sm mt-2">عودة لصفحة المدارس</button>
                        </div>
                    </div>
                </div>
            `;
        }
        function toggleAdminLogin() {
            const s = document.getElementById('schoolLoginPanel');
            const a = document.getElementById('adminLoginPanel');
            s.classList.toggle('hidden');
            a.classList.toggle('hidden');
        }

        async function handleTeacherLogin() {
            const nid = document.getElementById('teacherNID').value;
            if (nid.length !== 14) return showToast('يرجى إدخال 14 رقماً للرقم القومي', 'warning');

            state.isLoading = true;
            render();

            const res = await sendData('getTeacher', { nid: nid });
            state.isLoading = false;

            if (res.status === 'success') {
                if (res.data) {
                    // ALLOW LOGIN for existing teachers
                    showToast(`أهلاً بك مرة أخرى. تم التعرف على بياناتك المسجلة بمدرسة (${res.data.schoolName}). يمكنك المعاينة والطباعة الآن.`, 'success');
                    state.user = { ...res.data, type: 'teacher' };
                    state.editingIndex = null;
                    state.currentView = 'teacher_dashboard';
                    render();
                } else {
                    // Allow registration for new teachers
                    state.user = { nid: nid, type: 'teacher' };
                    state.tempFormData = { nid: nid }; // Initialize form with NID
                    state.editingIndex = null;
                    state.regFormStage = '';
                    state.currentView = 'teacher_dashboard';
                    render();
                }
            } else {
                showToast(res.message, 'error');
                render();
            }
        }

        async function handleSchoolLogin() {
            const code = state.loginForm.school;
            const pass = state.loginForm.password;

            if (!code) return showToast('يرجى اختيار المدرسة أولاً', 'warning');
            if (!pass) return showToast('يرجى إدخال كلمة المرور', 'warning');

            const school = state.schools.find(s => s.code == code && s.password == pass);
            if (school) {
                state.user = school;
                state.currentView = 'dashboard';
                await loadSchoolData();
            } else {
                showToast('كلمة المرور غير صحيحة أو البيانات غير متطابقة', 'error');
            }
        }

        async function handleAdminLogin() {
            const user = document.getElementById('adminUser').value.trim().toLowerCase();
            const pass = document.getElementById('adminPass').value;
            if (user === 'admin' && pass === 'admin123') {
                state.user = { name: 'Admin', type: 'admin', code: 'admin' };
                state.currentView = 'admin';
                await loadAllData();
            } else { showToast('خطأ في الدخول: تأكد من اسم المستخدم (admin) وكلمة المرور (admin123)', 'error'); }
        }

        async function loadSchoolData() {
            const result = await fetchData();
            if (result.status === 'success') {
                state.teachers = result.data.filter(t => t.schoolCode == state.user.code);
            }
            render();
        }

        async function loadAllData() {
            const result = await fetchData();
            const schoolsRes = await fetchData('getSchools'); // ALSO Fetch up-to-date Schools
            if (result.status === 'success') state.adminData = result.data;
            if (schoolsRes.status === 'success') state.schools = schoolsRes.data;
            render();
        }

        // --- DASHBOARD (Teacher Entry) ---
        function renderDashboard() {
            app.innerHTML = `
                <nav class="bg-gradient-to-l from-slate-900 to-slate-800 text-white shadow-lg rounded-t-xl overflow-hidden mb-6 flex justify-between p-4 items-center">
                    <div class="flex items-center gap-4">
                        <div class="bg-white p-1 rounded-lg shadow-inner"><img src="${LOGO_URL}" class="w-10 h-10 object-contain"></div>
                        <div><h2 class="font-bold text-xl text-yellow-500 font-cairo">بوابة المدارس</h2><p class="text-xs text-gray-300">إدارة العمرانية | مرحباً: ${state.user.name}</p></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="printSchoolTeacherList()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold flex gap-2"><i data-lucide="printer" class="w-4 h-4"></i> طباعة الكشف المجمع</button>
                        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-xs font-bold flex gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> خروج</button>
                    </div>
                </nav>
                ${renderSchoolContactSection()}
                ${renderTeacherForm()}
                ${renderTeacherTable()}
           `;
            if (state.editingIndex !== null) populateTeacherForm();
        }

        function renderTeacherDashboard() {
            app.innerHTML = `
                <nav class="bg-gradient-to-l from-blue-900 to-blue-800 text-white shadow-lg rounded-t-xl overflow-hidden mb-6 flex justify-between p-4 items-center">
                    <div class="flex items-center gap-4">
                        <div class="bg-white p-1 rounded-lg shadow-inner"><img src="${LOGO_URL}" class="w-10 h-10 object-contain"></div>
                        <div><h2 class="font-bold text-xl text-yellow-500 font-cairo">بوابة المعلمين</h2><p class="text-xs text-gray-300">إدارة العمرانية | مرحباً: ${state.user.name || 'مستخدم جديد'}</p></div>
                    </div>
                    <div class="flex gap-2">
                        ${state.user.name ? `<button onclick="printTeacherForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-xs font-bold flex gap-2"><i data-lucide="printer" class="w-4 h-4"></i> طباعة الاستمارة</button>` : ''}
                        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-xs font-bold flex gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> خروج</button>
                    </div>
                </nav>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-50 mb-6 no-print">
                    <h3 class="text-blue-900 font-bold mb-2 flex items-center gap-2">
                        <i data-lucide="info-circle" class="w-5 h-5"></i>
                        تعليمات هامة
                    </h3>
                    <p class="text-xs text-gray-600 leading-relaxed">يرجى التأكد من دقة البيانات المدخلة واختيار المدرسة الصحيحة. يمكنك العودة في أي وقت لتعديل بياناتك باستخدام رقمك القومي.</p>
                </div>
                ${renderTeacherForm()}
           `;

            // Auto fill the NID since it was used for login
            setTimeout(() => {
                const f = document.getElementById('teacherForm');
                if (f) {
                    f.elements['nid'].value = state.user.nid;
                    f.elements['nid'].readOnly = true;
                    f.elements['nid'].classList.add('bg-gray-100');
                    handleNIDInput(f.elements['nid']);
                    if (state.editingIndex) populateTeacherForm();
                }
            }, 50);
        }

        // --- Form Helper ---
        function handleFormChange(name, val) {
            state.tempFormData[name] = val;
            // No need to render here to avoid excessive re-renders while typing
        }

        function renderSchoolContactSection() {
            const s = state.user;
            return `
                <div class="bg-blue-900 text-white rounded-xl shadow-lg p-6 mb-8 border-r-8 border-yellow-500 relative overflow-hidden">
                    <div class="absolute -top-10 -left-10 w-40 h-40 bg-white/5 rounded-full blur-3xl"></div>
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                                <i data-lucide="phone-call" class="text-yellow-400"></i>
                                بيانات التواصل الخاصة بالمدرسة
                            </h3>
                            <p class="text-blue-200 text-xs">يرجى تسجيل بيانات التواصل بدقة لسهولة التنسيق مع الإدارة</p>
                        </div>
                        <button onclick="toggleElement('contactEditForm')" class="bg-yellow-500 hover:bg-yellow-600 text-blue-950 font-bold px-6 py-2 rounded-lg text-sm shadow-md transition-all flex items-center gap-2">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                            ${(s.managerName || s.hrName || s.itName) ? 'تحديث البيانات' : 'تسجيل البيانات الآن'}
                        </button>
                    </div>

                    <div id="contactEditForm" class="hidden mt-8 pt-8 border-t border-blue-800 animate-fade-in">
                        <form onsubmit="handleUpdateSchoolContact(event)" class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-blue-800/50 p-6 rounded-xl border border-blue-700">
                             <input type="hidden" name="code" value="${s.code}">
                             <input type="hidden" name="name" value="${s.name}">
                             <input type="hidden" name="password" value="${s.password}">
                             <input type="hidden" name="stage" value="${s.stage}">
                             <input type="hidden" name="stageName" value="${s.stageName}">
                             <input type="hidden" name="type" value="${s.type}">
                             <input type="hidden" name="typeName" value="${s.typeName}">

                             <div class="space-y-4">
                                <div class="bg-blue-950/50 p-4 rounded-lg">
                                    <label class="block text-xs font-bold text-yellow-500 mb-2 uppercase tracking-wider">مدير المدرسة</label>
                                    <input type="text" name="managerName" value="${s.managerName || ''}" placeholder="اسم مدير المدرسة" oninput="this.value = this.value.replace(/[^\\u0600-\\u06FF\\s]/g, '')" class="w-full p-2.5 bg-blue-900 border border-blue-700 rounded-lg text-white placeholder-blue-400 focus:ring-2 focus:ring-yellow-500 outline-none mb-3">
                                    <input type="text" name="managerPhone" value="${s.managerPhone || ''}" placeholder="هاتف المدير" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full p-2.5 bg-blue-900 border border-blue-700 rounded-lg text-white placeholder-blue-400 focus:ring-2 focus:ring-yellow-500 outline-none">
                                </div>
                             </div>
                             <div class="space-y-4">
                                <div class="bg-blue-950/50 p-4 rounded-lg">
                                    <label class="block text-xs font-bold text-yellow-500 mb-2 uppercase tracking-wider">شؤون العاملين</label>
                                    <input type="text" name="hrName" value="${s.hrName || ''}" placeholder="مسؤول شؤون العاملين" oninput="this.value = this.value.replace(/[^\\u0600-\\u06FF\\s]/g, '')" class="w-full p-2.5 bg-blue-900 border border-blue-700 rounded-lg text-white placeholder-blue-400 focus:ring-2 focus:ring-yellow-500 outline-none mb-3">
                                    <input type="text" name="hrPhone" value="${s.hrPhone || ''}" placeholder="هاتف شؤون العاملين" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full p-2.5 bg-blue-900 border border-blue-700 rounded-lg text-white placeholder-blue-400 focus:ring-2 focus:ring-yellow-500 outline-none">
                                </div>
                             </div>
                             <div class="space-y-4">
                                <div class="bg-blue-950/50 p-4 rounded-lg">
                                    <label class="block text-xs font-bold text-yellow-500 mb-2 uppercase tracking-wider">مسؤول الحاسب</label>
                                    <input type="text" name="itName" value="${s.itName || ''}" placeholder="مسؤول التطوير / الحاسب" oninput="this.value = this.value.replace(/[^\\u0600-\\u06FF\\s]/g, '')" class="w-full p-2.5 bg-blue-900 border border-blue-700 rounded-lg text-white placeholder-blue-400 focus:ring-2 focus:ring-yellow-500 outline-none mb-3">
                                    <input type="text" name="itPhone" value="${s.itPhone || ''}" placeholder="هاتف مسؤول الحاسب" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full p-2.5 bg-blue-900 border border-blue-700 rounded-lg text-white placeholder-blue-400 focus:ring-2 focus:ring-yellow-500 outline-none">
                                </div>
                             </div>
                             <div class="md:col-span-3">
                                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-[0.98] flex justify-center gap-2 items-center">
                                    <i data-lucide="check-circle"></i>
                                    حفظ بيانات التواصل
                                </button>
                             </div>
                        </form>
                    </div>

                    ${(s.managerName || s.hrName || s.itName) ? `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                        ${s.managerName ? `<div class="bg-blue-800/30 p-3 rounded-lg flex items-center gap-3 border border-blue-700/50"><div class="bg-yellow-500 text-blue-900 p-2 rounded-lg shadow-inner"><i data-lucide="user-tie" class="w-4 h-4"></i></div><div><div class="text-[10px] text-blue-300">المدير</div><div class="text-sm font-bold">${s.managerName}</div></div></div>` : ''}
                        ${s.hrName ? `<div class="bg-blue-800/30 p-3 rounded-lg flex items-center gap-3 border border-blue-700/50"><div class="bg-yellow-500 text-blue-900 p-2 rounded-lg shadow-inner"><i data-lucide="briefcase" class="w-4 h-4"></i></div><div><div class="text-[10px] text-blue-300">شؤون ع</div><div class="text-sm font-bold">${s.hrName}</div></div></div>` : ''}
                        ${s.itName ? `<div class="bg-blue-800/30 p-3 rounded-lg flex items-center gap-3 border border-blue-700/50"><div class="bg-yellow-500 text-blue-900 p-2 rounded-lg shadow-inner"><i data-lucide="monitor" class="w-4 h-4"></i></div><div><div class="text-[10px] text-blue-300">الحاسب</div><div class="text-sm font-bold">${s.itName}</div></div></div>` : ''}
                    </div>` : ''}
                </div>
            `;
        }

        // ... (removed setState, toggleElement, showToast, etc. as they are moved up)

        async function handleUpdateSchoolContact(e) {
            e.preventDefault();
            const form = new FormData(e.target);
            const data = Object.fromEntries(form.entries());

            // Validation
            const validatePhone = (p, label) => {
                if (p && !/^01[0125][0-9]{8}$/.test(p)) {
                    showToast(`رقم هاتف ${label} غير صحيح (يجب أن يبدأ بـ 01 ويتكون من 11 رقم)`, 'warning');
                    return false;
                }
                return true;
            };

            if (!validatePhone(data.managerPhone, 'المدير')) return;
            if (!validatePhone(data.hrPhone, 'شؤون العاملين')) return;
            if (!validatePhone(data.itPhone, 'مسؤول الحاسب')) return;

            const res = await sendData('updateSchool', { data: data });

            if (res.status === 'success') {
                showToast('تم تحديث بيانات التواصل بنجاح', 'success');
                // Update local state and re-render
                state.user = { ...state.user, ...data };
                // Also update in SCHOOLS_DB if needed
                const idx = SCHOOLS_DB.findIndex(s => s.code === data.code);
                if (idx !== -1) SCHOOLS_DB[idx] = { ...SCHOOLS_DB[idx], ...data };

                render();
            } else {
                showToast(res.message, 'error');
            }
        }

        function renderTeacherForm() {
            const isTeacher = state.user.type === 'teacher';
            return `
                 <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8 relative group">
                     <div class="h-1 bg-blue-500 w-full absolute top-0 left-0"></div>
                     <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                            <i data-lucide="${state.editingIndex !== null ? 'edit' : 'user-plus'}" class="text-blue-600"></i>
                            ${state.editingIndex !== null ? 'تعديل البيانات' : 'تسجيل جديد'}
                        </h3>
                        ${(state.user.type === 'school' && state.editingIndex !== null) ? `<button onclick="cancelEdit()" class="text-xs text-red-500 bg-red-50 px-3 py-1 rounded-full">إلغاء</button>` : ''}
                     </div>
                      <form onsubmit="handleRegister(event)" id="teacherForm" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                             <div><label class="block text-xs font-bold text-gray-700 mb-1">الرقم القومي <span class="text-red-500">*</span></label><input type="text" name="nid" value="${state.tempFormData.nid || ''}" maxlength="14" class="w-full p-2 border rounded focus:ring-1 focus:ring-blue-500 text-left font-mono" oninput="handleFormChange('nid', this.value); handleNIDInput(this)" required placeholder="14 digit NID"><div id="nidFeedback" class="text-[10px] h-4 mt-1"></div></div>
                             <div><label class="block text-xs font-bold text-gray-700 mb-1">الاسم رباعي <span class="text-red-500">*</span></label><input type="text" name="name" value="${state.tempFormData.name || ''}" oninput="handleFormChange('name', this.value); this.value = this.value.replace(/[^\\u0600-\\u06FF\\s]/g, '')" class="w-full p-2 border rounded focus:ring-1 focus:ring-blue-500" required></div>
                             <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs block mb-1">المحمول <span class="text-red-500">*</span></label><input type="tel" name="phone" value="${state.tempFormData.phone || ''}" oninput="handleFormChange('phone', this.value); this.value = this.value.replace(/[^0-9]/g, '')" required class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs block mb-1">العنوان</label><input type="text" name="address" value="${state.tempFormData.address || ''}" oninput="handleFormChange('address', this.value); this.value = this.value.replace(/[^\\u0600-\\u06FF\\s0-9\\s\\.\\-\\/]/g, '')" class="w-full p-2 border rounded"></div>
                             </div>
                             ${isTeacher ? `
                             <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs block mb-1 font-bold text-blue-800">اختر المرحلة <span class="text-red-500">*</span></label>
                                        <select onchange="setState('regFormStage', this.value)" class="w-full p-2 border rounded bg-white text-sm">
                                            <option value="">-- اختر المرحلة --</option>
                                            ${[...new Set(state.schools.filter(s => s.type !== 'admin').map(s => s.stage))].map(stage => {
                const stageName = state.schools.find(s => s.stage === stage)?.stageName || stage;
                return `<option value="${stage}" ${state.regFormStage === stage ? 'selected' : ''}>${stageName}</option>`;
            }).join('')}
                                        </select>
                                    </div>
                                    <div class="${!state.regFormStage ? 'opacity-50 pointer-events-none' : ''}">
                                        <label class="text-xs block mb-1 font-bold text-blue-800">اختر المدرسة <span class="text-red-500">*</span></label>
                                        <select name="schoolCode" ${!state.regFormStage ? 'disabled' : ''} required class="w-full p-2 border rounded bg-white text-sm" onchange="handleFormChange('schoolCode', this.value); const s = state.schools.find(x=>x.code===this.value); this.form.elements['schoolName'].value = s ? s.name : ''; handleFormChange('schoolName', s ? s.name : '')">
                                            <option value="">-- اختر مدرستك --</option>
                                            ${state.schools.filter(s => s.stage === state.regFormStage).map(s => `<option value="${s.code}" ${state.tempFormData.schoolCode === s.code ? 'selected' : ''}>${s.name}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <input type="hidden" name="schoolName" value="${state.tempFormData.schoolName || ''}">
                             </div>
                             ` : ''}
                        </div>
                        <div class="space-y-4">
                             <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs block mb-1">المادة <span class="text-red-500">*</span></label><select name="subject" required onchange="handleFormChange('subject', this.value)" class="w-full p-2 border rounded bg-white"><option value="">اختر...</option><option ${state.tempFormData.subject === 'لغة عربية' ? 'selected' : ''}>لغة عربية</option><option ${state.tempFormData.subject === 'رياضيات' ? 'selected' : ''}>رياضيات</option><option ${state.tempFormData.subject === 'رياضيات لغات' ? 'selected' : ''}>رياضيات لغات</option><option ${state.tempFormData.subject === 'لغة إنجليزية' ? 'selected' : ''}>لغة إنجليزية</option><option ${state.tempFormData.subject === 'علوم' ? 'selected' : ''}>علوم</option><option ${state.tempFormData.subject === 'علوم لغات' ? 'selected' : ''}>علوم لغات</option><option ${state.tempFormData.subject === 'دراسات' ? 'selected' : ''}>دراسات</option><option ${state.tempFormData.subject === 'تربية مسيحية' ? 'selected' : ''}>تربية مسيحية</option><option ${state.tempFormData.subject === 'جغرافيا' ? 'selected' : ''}>جغرافيا</option><option ${state.tempFormData.subject === 'تاريخ' ? 'selected' : ''}>تاريخ</option><option ${state.tempFormData.subject === 'فيزياء' ? 'selected' : ''}>فيزياء</option><option ${state.tempFormData.subject === 'فيزياء لغات' ? 'selected' : ''}>فيزياء لغات</option><option ${state.tempFormData.subject === 'كيمياء' ? 'selected' : ''}>كيمياء</option><option ${state.tempFormData.subject === 'كيمياء لغات' ? 'selected' : ''}>كيمياء لغات</option><option ${state.tempFormData.subject === 'أحياء' ? 'selected' : ''}>أحياء</option><option ${state.tempFormData.subject === 'أحياء لغات' ? 'selected' : ''}>أحياء لغات</option><option ${state.tempFormData.subject === 'علوم متكاملة' ? 'selected' : ''}>علوم متكاملة</option><option ${state.tempFormData.subject === 'علم نفس' ? 'selected' : ''}>علم نفس</option><option ${state.tempFormData.subject === 'فلسفة ومنطق' ? 'selected' : ''}>فلسفة ومنطق</option><option ${state.tempFormData.subject === 'أنشطة' ? 'selected' : ''}>أنشطة</option><option ${state.tempFormData.subject === 'مواد تجارية' ? 'selected' : ''}>مواد تجارية</option></select></div>
                                <div><label class="text-xs block mb-1">كود المعلم</label><input type="text" name="teacherCode" value="${state.tempFormData.teacherCode || ''}" oninput="handleFormChange('teacherCode', this.value); this.value = this.value.replace(/[^0-9]/g, '')" class="w-full p-2 border rounded"></div>
                             </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs block mb-1">المؤهل <span class="text-red-500">*</span></label><input type="text" name="qualification" value="${state.tempFormData.qualification || ''}" oninput="handleFormChange('qualification', this.value)" required class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs block mb-1">الجامعة</label><input type="text" name="university" value="${state.tempFormData.university || ''}" oninput="handleFormChange('university', this.value)" class="w-full p-2 border rounded"></div>
                             </div>
                             <div class="grid grid-cols-3 gap-2">
                                <div><label class="text-xs block mb-1">سنة التخرج</label><input type="number" name="gradYear" value="${state.tempFormData.gradYear || ''}" oninput="handleFormChange('gradYear', this.value)" class="w-full p-2 border rounded"></div>
                                <div><label class="text-xs block mb-1">التقدير</label><select name="grade" onchange="handleFormChange('grade', this.value)" class="w-full p-2 border rounded"><option ${state.tempFormData.grade === 'جيد' ? 'selected' : ''}>جيد</option><option ${state.tempFormData.grade === 'جيد جدا' ? 'selected' : ''}>جيد جدا</option><option ${state.tempFormData.grade === 'امتياز' ? 'selected' : ''}>امتياز</option><option ${state.tempFormData.grade === 'مقبول' ? 'selected' : ''}>مقبول</option></select></div>
                                <div><label class="text-xs block mb-1">التعيين</label><select name="contractType" onchange="handleFormChange('contractType', this.value)" class="w-full p-2 border rounded"><option ${state.tempFormData.contractType === 'أساسي' ? 'selected' : ''}>أساسي</option><option ${state.tempFormData.contractType === 'بالأجر' ? 'selected' : ''}>بالأجر</option><option ${state.tempFormData.contractType === 'بالمعاش' ? 'selected' : ''}>بالمعاش</option></select></div>
                             </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs block mb-1">تاريخ العمل</label><input type="date" name="startDate" value="${state.tempFormData.startDate || ''}" onchange="handleFormChange('startDate', this.value)" class="w-full p-2 border rounded text-xs"></div>
                                <div><label class="text-xs block mb-1">دبلوم تربوي</label><input type="text" name="diploma" value="${state.tempFormData.diploma || ''}" oninput="handleFormChange('diploma', this.value)" class="w-full p-2 border rounded"></div>
                             </div>
                             <input type="hidden" name="dob" id="dobHidden" value="${state.tempFormData.dob || ''}">
                             <input type="hidden" name="gov" id="govHidden" value="${state.tempFormData.gov || ''}">
                        </div>
                        <div class="lg:col-span-2 pt-4 border-t"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 shadow-lg flex justify-center gap-2"><i data-lucide="save"></i> ${state.editingIndex ? 'حفظ التعديلات' : 'إتمام التسجيل الآن'}</button></div>
                      </form>
                 </div>`;
        }

        function renderTeacherTable() {
            return `
                 <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b flex justify-between items-center"><h3 class="font-bold flex items-center gap-2"><i data-lucide="database" class="w-4 h-4"></i> المسجلين (${state.teachers.length})</h3><button onclick="loadSchoolData()" class="text-xs bg-white border px-3 py-1 rounded hover:bg-gray-100"><i data-lucide="refresh-cw" class="w-3 h-3 inline"></i> تحديث</button></div>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 text-gray-600 sticky top-0">
                                <tr><th class="p-3 text-right">الاسم</th><th class="p-3 text-center">الرقم القومي</th><th class="p-3 text-center">المؤهل / الجامعة</th><th class="p-3 text-center">المادة</th><th class="p-3 text-center">بيانات الوظيفة</th><th class="p-3 text-center">إجراءات</th></tr>
                            </thead>
                            <tbody class="divide-y">
                                ${state.teachers.length ? state.teachers.map((t) => `
                                    <tr class="hover:bg-blue-50">
                                        <td class="p-3 font-bold text-gray-700">${t.name}<br><span class="text-xs text-gray-400 font-mono">${t.phone}</span></td>
                                        <td class="p-3 text-center font-mono text-sm">${t.nid}</td>
                                        <td class="p-3 text-center text-sm">${t.qualification} (${t.gradYear})<br><span class="text-xs text-gray-400">${t.university || '-'}</span></td>
                                        <td class="p-3 text-center text-blue-600 font-bold">${t.subject}</td>
                                        <td class="p-3 text-center text-xs"><span class="bg-gray-100 px-2 py-1 rounded border">${t.contractType}</span>${t.teacherCode ? `<br><span class="text-gray-400 mt-1 inline-block">كود: ${t.teacherCode}</span>` : ''}</td>
                                        <td class="p-3 text-center flex justify-center gap-2 items-center"><button onclick="editTeacher('${t.nid}')" class="text-blue-500 hover:bg-blue-100 p-1.5 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteTeacher('${t.nid}')" class="text-red-500 hover:bg-red-100 p-1.5 rounded"><i data-lucide="trash" class="w-4 h-4"></i></button></td>
                                    </tr>`).join('') : `<tr><td colspan=6 class="p-6 text-center text-gray-400">لا توجد بيانات</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                 </div>`;
        }

        function populateTeacherForm() {
            let t;
            if (state.user.type === 'teacher') {
                t = state.user;
            } else {
                t = state.teachers.find(x => x.nid == state.editingIndex);
            }
            if (t) {
                const f = document.getElementById('teacherForm');
                for (let k in t) {
                    if (f.elements[k]) f.elements[k].value = t[k];
                }
            }
        }

        // --- ADMIN DASHBOARD ---
        function renderAdminDashboard() {
            // Stats
            const total = state.adminData ? state.adminData.length : 0;
            const schoolsCount = state.schools ? state.schools.length : 0;
            // Analytics
            const byGender = { 'ذكر': 0, 'أنثى': 0 };
            const byStage = { 'Abdaey': 0, 'Eadady': 0, 'Sanawy': 0 };
            const byGov = {};
            const topSchools = {};

            if (state.adminData) {
                state.adminData.forEach(t => {
                    if (t && t.nid && t.nid.length >= 13) {
                        const gCode = t.nid.substring(12, 13);
                        byGender[parseInt(gCode) % 2 !== 0 ? 'ذكر' : 'أنثى']++;
                    }
                    if (t.schoolStage) byStage[t.schoolStage] = (byStage[t.schoolStage] || 0) + 1;
                    if (t.gov) byGov[t.gov] = (byGov[t.gov] || 0) + 1;
                    if (t.schoolName) topSchools[t.schoolName] = (topSchools[t.schoolName] || 0) + 1;
                });
            }

            // Prep Charts Data
            const top5Schools = Object.entries(topSchools).sort((a, b) => b[1] - a[1]).slice(0, 5);

            app.innerHTML = `
                <div class="bg-gray-900 text-white p-6 rounded-b-xl mb-8 flex flex-col md:flex-row justify-between items-center shadow-2xl gap-4">
                    <div><h1 class="text-2xl font-bold flex items-center gap-3"><i data-lucide="layout-dashboard" class="text-red-500"></i> لوحة التحكم المركزية</h1><p class="text-gray-400 text-sm mt-1">إحصائيات شاملة لإدارة العمرانية</p></div>
                    <div class="flex gap-3">
                         <button onclick="loadAllData()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg flex gap-2"><i data-lucide="refresh-cw" class="w-4 h-4"></i> تحديث</button>
                         <button onclick="exportFullData()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-bold flex gap-2"><i data-lucide="download" class="w-4 h-4"></i> اكسيل</button>
                         <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-bold">خروج</button>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow border-b-4 border-blue-500 group hover:shadow-lg transition-all">
                        <div class="flex justify-between items-start">
                             <div><div class="text-gray-500 text-sm font-bold mb-1">إجمالي المعلمين</div><div class="text-4xl font-bold text-gray-800">${total}</div></div>
                             <div class="bg-blue-50 p-2 rounded text-blue-600"><i data-lucide="users" class="w-6 h-6"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border-b-4 border-yellow-500 group hover:shadow-lg transition-all">
                        <div class="flex justify-between items-start">
                             <div><div class="text-gray-500 text-sm font-bold mb-1">عدد المدارس</div><div class="text-4xl font-bold text-gray-800">${schoolsCount}</div></div>
                             <div class="bg-yellow-50 p-2 rounded text-yellow-600"><i data-lucide="building" class="w-6 h-6"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border-b-4 border-green-500 group hover:shadow-lg transition-all">
                         <div class="flex justify-between items-start">
                             <div><div class="text-gray-500 text-sm font-bold mb-1">نسبة التسجيل</div><div class="text-4xl font-bold text-gray-800">%${Math.round((total / (schoolsCount * 50)) * 100) || 0}</div></div> <!-- Mock Target 50/school -->
                             <div class="bg-green-50 p-2 rounded text-green-600"><i data-lucide="activity" class="w-6 h-6"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border-b-4 border-purple-500 group hover:shadow-lg transition-all">
                         <div class="flex justify-between items-start">
                             <div><div class="text-gray-500 text-sm font-bold mb-1">الذكور / الإناث</div><div class="text-xl font-bold text-gray-800">${byGender['ذكر']} <span class="text-gray-400 text-sm">/</span> ${byGender['أنثى']}</div></div>
                             <div class="bg-purple-50 p-2 rounded text-purple-600"><i data-lucide="pie-chart" class="w-6 h-6"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                     <div class="bg-white p-6 rounded-xl shadow">
                         <h3 class="font-bold mb-6 text-gray-700 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-500"></i> التوزيع حسب المراحل</h3>
                         <div class="h-64"><canvas id="stageChart"></canvas></div>
                     </div>
                     <div class="bg-white p-6 rounded-xl shadow">
                         <h3 class="font-bold mb-6 text-gray-700 flex items-center gap-2"><i data-lucide="award" class="w-5 h-5 text-yellow-500"></i> أكثر المدارس نشاطاً</h3>
                         <div class="h-64"><canvas id="schoolChart"></canvas></div>
                     </div>
                </div>

                <!-- Schools Mgmt (Existing) -->

                <!-- Tabs for Schools Management -->
                <div class="bg-white rounded-xl shadow p-6 mb-8">
                   <h3 class="font-bold mb-4 text-xl border-b pb-2">إدارة المدارس (تلقائي)</h3>
                   <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div>
                            <h4 class="font-bold text-gray-600 mb-2 flex justify-between items-center">
                                <span id="schoolFormTitle">إضافة مدرسة جديدة</span>
                                ${state.editingSchool ? `<button onclick="cancelSchoolEdit()" class="text-xs text-red-500 bg-red-50 px-2 py-1 rounded">إلغاء</button>` : ''}
                            </h4>
                            <form onsubmit="handleAddSchool(event)" id="schoolForm" class="space-y-3 p-4 bg-gray-50 rounded-lg border text-xs">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" name="code" id="schoolCodeInput" placeholder="كود المدرسة (Required)" required class="w-full p-2 border rounded" ${state.editingSchool ? 'readonly class="bg-gray-200"' : ''}>
                                    <input type="text" name="password" placeholder="كلمة المرور (أرقام)" required class="w-full p-2 border rounded" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                </div>
                                 <input type="text" name="name" placeholder="اسم المدرسة الرسمي" oninput="this.value = this.value.replace(/[^\\u0600-\\u06FF\\s]/g, '')" required class="w-full p-2 border rounded">
                                <div class="grid grid-cols-2 gap-2">
                                     <select name="stage" class="w-full p-2 border rounded"><option value="Abdaey">الابتدائية</option><option value="Eadady">الإعدادية</option><option value="Sanawy">الثانوية</option></select>
                                     <select name="type" class="w-full p-2 border rounded">
                                         <option value="official">رسمي</option>
                                         <option value="official_lang">رسمي لغات</option>
                                         <option value="private_arabic">خاص عربي</option>
                                         <option value="private_lang">خاص لغات</option>
                                         <option value="international">دولي</option>
                                         <option value="cultural">ثقافي</option>
                                     </select>
                                </div>
                                
                                 <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded shadow hover:bg-blue-700 mt-2">${state.editingSchool ? 'حفظ التعديلات' : 'إضافة المدرسة'}</button>
                            </form>
                        </div>
                        <div class="col-span-2">
                            <h4 class="font-bold text-gray-600 mb-2">قائمة المدارس المسجلة</h4>
                            <div class="overflow-auto max-h-64 border rounded">
                                 <table class="w-full text-sm text-right">
                                    <thead class="bg-gray-100 font-bold border-b">
                                        <tr>
                                            <th class="p-2">المدرسة</th>
                                            <th class="p-2 text-center">المرحلة / النوع</th>
                                            <th class="p-2 text-center">بيانات التواصل (المدير / شؤون ع / حاسب)</th>
                                            <th class="p-2 text-center text-xs">باسورد</th>
                                            <th class="p-2 text-center">تحكم</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${state.schools.map(s => `
                                            <tr class="border-b hover:bg-gray-50 transition-colors">
                                                <td class="p-2">
                                                    <div class="font-bold text-slate-700">${s.name}</div>
                                                    <div class="text-[10px] font-mono text-gray-400">Code: ${s.code}</div>
                                                </td>
                                                <td class="p-2 text-center">
                                                    <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full text-[10px] border border-blue-100">${s.stageName || s.stage}</span><br>
                                                    <span class="text-gray-500 text-[10px] mt-1 inline-block">${s.typeName || s.type}</span>
                                                </td>
                                                <td class="p-2">
                                                    <div class="grid grid-cols-3 gap-1 text-[10px]">
                                                        <div class="bg-gray-100 p-1 rounded-md text-center ${s.managerName ? 'border-r-2 border-yellow-500' : 'opacity-30'}">
                                                            <div class="font-bold truncate" title="${s.managerName || 'غير مسجل'}">${s.managerName || '-'}</div>
                                                            <div class="text-gray-400 truncate">${s.managerPhone || ''}</div>
                                                        </div>
                                                        <div class="bg-gray-100 p-1 rounded-md text-center ${s.hrName ? 'border-r-2 border-green-500' : 'opacity-30'}">
                                                            <div class="font-bold truncate" title="${s.hrName || 'غير مسجل'}">${s.hrName || '-'}</div>
                                                            <div class="text-gray-400 truncate">${s.hrPhone || ''}</div>
                                                        </div>
                                                        <div class="bg-gray-100 p-1 rounded-md text-center ${s.itName ? 'border-r-2 border-blue-500' : 'opacity-30'}">
                                                            <div class="font-bold truncate" title="${s.itName || 'غير مسجل'}">${s.itName || '-'}</div>
                                                            <div class="text-gray-400 truncate">${s.itPhone || ''}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="p-2 text-center font-mono text-xs text-gray-300 select-all hover:text-slate-600 transition-colors">${s.password}</td>
                                                <td class="p-2">
                                                    <div class="flex justify-center gap-2">
                                                        <button onclick="editSchool('${s.code}')" class="text-blue-500 hover:bg-blue-100 p-1 rounded transition-colors" title="تعديل"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                                        <button onclick="deleteSchool('${s.code}')" class="text-red-500 hover:bg-red-100 p-1 rounded transition-colors" title="حذف"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                   </div>
                </div>
            `;
            lucide.createIcons();

            // Init Charts
            new Chart(document.getElementById('stageChart'), {
                type: 'doughnut',
                data: {
                    labels: ['الابتدائية', 'الإعدادية', 'الثانوية'],
                    datasets: [{
                        data: [byStage['Abdaey'] || 0, byStage['Eadady'] || 0, byStage['Sanawy'] || 0],
                        backgroundColor: ['#3b82f6', '#eab308', '#ec4899']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            new Chart(document.getElementById('schoolChart'), {
                type: 'bar',
                data: {
                    labels: top5Schools.map(x => x[0]),
                    datasets: [{
                        label: 'عدد المعلمين',
                        data: top5Schools.map(x => x[1]),
                        backgroundColor: '#10b981',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // --- Logic Handlers ---

        const GOV_MAP = {
            '01': 'القاهرة', '02': 'الإسكندرية', '03': 'بورسعيد', '04': 'السويس', '11': 'دمياط',
            '12': 'الدقهلية', '13': 'الشرقية', '14': 'القليوبية', '15': 'كفر الشيخ', '16': 'الغربية',
            '17': 'المنوفية', '18': 'البحيرة', '19': 'الإسماعيلية', '21': 'الجيزة', '22': 'بني سويف',
            '23': 'الفيوم', '24': 'المنيا', '25': 'أسيوط', '26': 'سوهاج', '27': 'قنا', '28': 'أسوان',
            '29': 'الأقصر', '31': 'البحر الأحمر', '32': 'الوادي الجديد', '33': 'مطروح', '34': 'شمال سيناء',
            '35': 'جنوب سيناء', '88': 'خارج الجمهورية'
        };

        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let years = today.getFullYear() - birth.getFullYear();
            let months = today.getMonth() - birth.getMonth();
            let days = today.getDate() - birth.getDate();

            if (days < 0) {
                months--;
                days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }
            return { Y: years, M: months, D: days };
        }

        function handleNIDInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            const nid = input.value;
            const feedback = document.getElementById('nidFeedback');

            // 1. Check Length
            if (nid.length !== 14) {
                feedback.innerHTML = '<span class="text-gray-400">أدخل 14 رقم...</span>';
                return;
            }

            // 2. Check Duplicates (Local)
            const isDuplicate = state.teachers.some(t => t.nid === nid && t.nid !== state.editingIndex);
            if (isDuplicate) {
                feedback.innerHTML = '<span class="text-red-600 font-bold"><i data-lucide="alert-octagon" class="w-3 h-3 inline"></i> هذا الرقم مسجل بالفعل في مدرستك!</span>';
                lucide.createIcons();
                return;
            }

            // 3. Parse Data
            const century = nid[0];
            const yearPart = nid.substring(1, 3);
            const monthPart = nid.substring(3, 5);
            const dayPart = nid.substring(5, 7);
            const govCode = nid.substring(7, 9);
            const genderCode = nid.substring(12, 13);

            const fullYear = (century == 2 ? 1900 : 2000) + parseInt(yearPart);
            const birthDateStr = `${fullYear}-${monthPart}-${dayPart}`;

            // Validate Logic Date
            const birthDate = new Date(birthDateStr);
            if (isNaN(birthDate.getTime())) {
                feedback.innerHTML = '<span class="text-red-500">تاريخ وهمي غير صحيح</span>';
                return;
            }

            const age = calculateAge(birthDateStr);
            const govName = GOV_MAP[govCode] || 'غير معروف';
            const gender = parseInt(genderCode) % 2 !== 0 ? 'ذكر' : 'أنثى';

            // 4. Show Info Card
            feedback.innerHTML = `
                <div class="flex gap-2 text-[10px] mt-1 bg-blue-50 p-2 rounded border border-blue-100 items-center">
                    <span class="font-bold text-blue-700">${gender}</span>
                    <span class="text-gray-400">|</span>
                    <span class="text-gray-700">${govName}</span>
                    <span class="text-gray-400">|</span>
                    <span class="text-gray-700 font-mono">${age.Y} سنة ${age.M} شهر</span>
                    <span class="text-gray-400">|</span>
                    <span class="text-green-600 font-bold font-mono">${birthDateStr}</span>
                </div>
            `;

            // 5. Fill Hidden Fields
            document.getElementById('dobHidden').value = birthDateStr;
            document.getElementById('govHidden').value = govName;
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = new FormData(e.target);
            const data = Object.fromEntries(form.entries());

            // Validate NID
            const nidFeedback = document.getElementById('nidFeedback').textContent;
            if (nidFeedback.includes('مسجل بالفعل') || nidFeedback === '' || nidFeedback.includes('أدخل 14')) {
                return showToast('يرجى التأكد من الرقم الرقم القومي (غير صحيح أو مكرر)', 'error');
            }

            if (data.phone && !/^01[0125][0-9]{8}$/.test(data.phone)) {
                return showToast('رقم الهاتف غير صحيح (يجب أن يبدأ بـ 01 ويتكون من 11 رقم)', 'warning');
            }

            if (state.user.type === 'school') {
                data.schoolCode = state.user.code;
                data.schoolName = state.user.name;
                data.schoolStage = state.user.stageName;
            } else if (state.user.type === 'teacher') {
                // schoolCode and schoolName are already in the form for teachers
                const school = state.schools.find(s => s.code === data.schoolCode);
                data.schoolStage = school ? school.stageName : '';
            }

            const action = state.editingIndex ? 'update' : 'register';
            const res = await sendData(action, { data: data });
            if (res.status === 'success') {
                showToast(state.editingIndex ? 'تم التعديل بنجاح' : 'تم التسجيل بنجاح. برجاء طباعة الاستمارة الآن.', 'success');
                if (state.user.type === 'school') {
                    state.editingIndex = null;
                    state.tempFormData = {};
                    await loadSchoolData();
                    document.getElementById('teacherForm').reset();
                } else {
                    // Critical for print: update state.user with the full registered data
                    state.user = { ...state.user, ...data };
                    render();
                }
            }
            else { showToast('خطأ: ' + (res.message || 'فشل الاتصال'), 'error'); }
        }

        function printSchoolTeacherList() {
            const s = state.user;
            const data = state.teachers;
            if (!data || data.length === 0) return showToast('لا توجد بيانات معلمين لطباعتها', 'info');

            const printWindow = window.open('', '_blank');
            const html = `
                <html lang="ar" dir="rtl">
                <head>
                    <title>كشف مجمع معلمين - ${s.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4 landscape; margin: 1cm; }
                        body { font-family: 'Cairo', sans-serif; padding: 10px; color: #000; direction: rtl; }
                        .header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .title { text-align: center; font-size: 18px; font-weight: bold; flex-grow: 1; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
                        th, td { border: 1px solid #000; padding: 6px 4px; text-align: center; }
                        th { background: #f2f2f2; font-weight: bold; }
                        .footer { margin-top: 30px; display: flex; justify-content: space-between; }
                        .sign { text-align: center; width: 30%; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div style="font-size: 10px;">محافظة الجيزة<br>مديرية التربية والتعليم<br>إدارة العمرانية التعليمية</div>
                        <div style="text-align: center;"><img src="${LOGO_URL}" style="height: 60px; margin-bottom: 5px;"><div class="title">كشف مجمع ببيانات المعلمين المسجلين<br>${s.name} (${s.stageName})</div></div>
                        <div style="font-size: 10px; text-align: left;">تاريخ الكشف: ${new Date().toLocaleDateString('ar-EG')}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30px;">م</th>
                                <th>الاسم</th>
                                <th>الرقم القومي</th>
                                <th>المادة / التخصص</th>
                                <th>الهاتف</th>
                                <th>المؤهل</th>
                                <th>نوع التعاقد</th>
                                <th>ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((t, idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td style="text-align: right;">${t.name}</td>
                                    <td style="font-family: monospace;">${t.nid}</td>
                                    <td>${t.subject}</td>
                                    <td style="font-family: monospace;">${t.phone}</td>
                                    <td>${t.qualification}</td>
                                    <td>${t.contractType}</td>
                                    <td></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="footer">
                        <div class="sign">شؤون العاملين بالمدرسة<br><br>...........................</div>
                        <div class="sign">ختم المدرسة<br><br><br></div>
                        <div class="sign">يعتمد مدير المدرسة<br><br>...........................</div>
                    </div>
                    <script>
                        window.onload = () => { window.print(); window.onafterprint = () => window.close(); };
                    <\/script>` + `
                </body>
                </html>
            `;
            printWindow.document.write(html);
            printWindow.document.close();
        }

        function printTeacherForm() {
            const t = state.user;
            const printWindow = window.open('', '_blank');
            const html = `
                <html lang="ar" dir="rtl">
                <head>
                    <title>استمارة بيانات المعلم - ${t.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 1cm; }
                        body { font-family: 'Cairo', sans-serif; padding: 20px; color: #333; line-height: 1.4; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; }
                        .title { text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #000; border: 2px solid #000; display: inline-block; padding: 5px 30px; margin-right: auto; margin-left: auto; display: block; width: fit-content; }
                        .grid { display: grid; grid-template-cols: 1fr 1fr; gap: 10px 40px; }
                        .item { border-bottom: 1px dotted #ccc; padding: 5px 0; display: flex; justify-content: space-between; }
                        .label { font-weight: bold; color: #000; }
                        .value { border-bottom: 1px solid #777; flex-grow: 1; margin-right: 10px; text-align: center; }
                        .footer { margin-top: 40px; display: flex; justify-content: space-between; border-top: 1px solid #eee; pt-20 }
                        .sign-box { text-align: center; width: 45%; border: 1px solid #eee; padding: 10px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div style="font-size: 12px;">محافظة الجيزة<br>مديرية التربية والتعليم<br>إدارة العمرانية التعليمية</div>
                        <div style="text-align: center;"><img src="${LOGO_URL}" style="height: 70px; margin-bottom: 5px;"><div style="font-weight: bold; font-size: 20px;">استمارة تسجيل بيانات معلم</div><div style="font-size: 14px; font-weight: normal;">(قاعدة البيانات الموحدة)</div></div>
                        <div style="text-align: left; font-size: 12px;">تاريخ الطباعة:<br>${new Date().toLocaleDateString('ar-EG')}</div>
                    </div>
                    
                    <div class="title">البيانات الشخصية والوظيفية</div>
                    
                    <div class="grid">
                        <div class="item"><span class="label">الاسم الكامل:</span> <span class="value">${t.name}</span></div>
                        <div class="item"><span class="label">الرقم القومي:</span> <span class="value">${t.nid}</span></div>
                        <div class="item"><span class="label">جهة العمل (المدرسة):</span> <span class="value">${t.schoolName}</span></div>
                        <div class="item"><span class="label">المرحلة التعليمية:</span> <span class="value">${t.schoolStage || '---'}</span></div>
                        <div class="item"><span class="label">كود المعلم:</span> <span class="value">${t.teacherCode || '---'}</span></div>
                        <div class="item"><span class="label">التخصص / المادة:</span> <span class="value">${t.subject}</span></div>
                        <div class="item"><span class="label">رقم الهاتف:</span> <span class="value">${t.phone}</span></div>
                        <div class="item"><span class="label">المؤهل الدراسي:</span> <span class="value">${t.qualification}</span></div>
                        <div class="item"><span class="label">الجامعة:</span> <span class="value">${t.university || '---'}</span></div>
                        <div class="item"><span class="label">سنة العمل:</span> <span class="value">${t.startDate || '---'}</span></div>
                        <div class="item"><span class="label">نوع التعاقد:</span> <span class="value">${t.contractType}</span></div>
                        <div class="item"><span class="label">العنوان الحالي:</span> <span class="value">${t.address || '---'}</span></div>
                    </div>
                    
                    <div class="footer">
                        <div class="sign-box">إقرار المعلم<br><br>أقر أنا الموضح بياناتي أعلاه بصحة البيانات المسجلة<br><br>التوقيع: ...........................</div>
                        <div class="sign-box">يعتمد مدرسة / ${t.schoolName}<br><br>ختم المدرسة<br><br>مدير المدرسة: ...........................</div>
                    </div>
                    
                    <script>
                        window.onload = () => {
                            window.print();
                            window.onafterprint = () => window.close();
                        };
                    <\/script>` + `
                </body>
                </html>
            `;
            printWindow.document.write(html);
            printWindow.document.close();
        }

        async function deleteTeacher(nid) {
            if (!confirm('حذف نهائي؟')) return; const res = await sendData('delete', {
                nid: nid,
                schoolCode: state.user.code
            }); if (res.status === 'success') await loadSchoolData();
        }
        function editTeacher(nid) { state.editingIndex = nid; render(); }
        function cancelEdit() { state.editingIndex = null; render(); }
        function logout() { state.user = null; state.currentView = 'login'; state.regFormStage = ''; render(); }
        function clearConfig() { localStorage.removeItem('TEACHER_APP_API_URL'); location.reload(); }
        function render() {
            app.innerHTML = '';
            if (state.isLoading) { renderLoading(); return; }
            switch (state.currentView) {
                case 'setup': renderSetup(); break;
                case 'login': renderLogin(); break;
                case 'dashboard': renderDashboard(); break;
                case 'teacher_dashboard': renderTeacherDashboard(); break;
                case 'admin': renderAdminDashboard(); break;
            }
            lucide.createIcons();
        }

        // School Mgmt
        async function handleAddSchool(e) {
            e.preventDefault();
            const form = new FormData(e.target);
            const data = Object.fromEntries(form.entries());

            // Map nice names
            data.stageName = data.stage === 'Abdaey' ? 'الابتدائية' : (data.stage === 'Eadady' ? 'الإعدادية' : 'الثانوية');

            const typeMap = {
                'official': 'رسمي',
                'official_lang': 'رسمي لغات',
                'private_arabic': 'خاص عربي',
                'private_lang': 'خاص لغات',
                'international': 'دولي',
                'cultural': 'ثقافي'
            };
            data.typeName = typeMap[data.type] || data.type;

            const action = state.editingSchool ? 'updateSchool' : 'addSchool';
            const res = await sendData(action, { data: data });

            if (res.status === 'success') {
                showToast(state.editingSchool ? 'تم تعديل بيانات المدرسة' : 'تم إضافة المدرسة بنجاح', 'success');
                state.editingSchool = false;
                document.getElementById('schoolForm').reset();
                await loadAllData();
            } else {
                showToast(res.message, 'error');
            }
        }

        async function deleteSchool(code) {
            if (!confirm('حذف المدرسة؟')) return;
            const res = await sendData('deleteSchool', { code: code });
            if (res.status === 'success') await loadAllData();
        }

        function editSchool(code) {
            const s = state.schools.find(x => x.code === code);
            if (!s) return;
            state.editingSchool = true;
            render(); // Re-render to show edit state
            // Fill form after render
            setTimeout(() => {
                const f = document.getElementById('schoolForm');
                for (let k in s) {
                    if (f.elements[k]) f.elements[k].value = s[k];
                }
                document.getElementById('schoolFormTitle').textContent = `تعديل مدرسة: ${s.name}`;
                document.getElementById('schoolCodeInput').readOnly = true;
                document.getElementById('schoolCodeInput').classList.add('bg-gray-200');
            }, 50);
        }

        function cancelSchoolEdit() {
            state.editingSchool = false;
            render();
        }

        function exportFullData() {
            const data = state.adminData;
            if (!data.length) return showToast('لا توجد بيانات للتحميل', 'warning');
            const headers = Object.keys(data[0]);
            const csv = [headers.join(','), ...data.map(r => headers.map(h => `"${r[h]}"`).join(','))].join('\n');
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'All_Teachers.csv'; a.click();
        }

        // --- Toast Notification System ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const colors = {
                success: 'bg-green-100 border-green-500 text-green-700',
                error: 'bg-red-100 border-red-500 text-red-700',
                info: 'bg-blue-100 border-blue-500 text-blue-700',
                warning: 'bg-yellow-100 border-yellow-500 text-yellow-700'
            };
            const icons = {
                success: 'check-circle',
                error: 'alert-circle',
                info: 'info',
                warning: 'alert-triangle'
            };

            toast.className = `${colors[type]} border-l-4 p-4 rounded shadow-lg flex items-center gap-3 min-w-[300px] max-w-md
toast-enter`;
            toast.innerHTML = `
<i data-lucide="${icons[type]}" class="w-6 h-6"></i>
<div>
    <p class="font-bold text-sm">${type === 'success' ? 'نجاح' : (type === 'error' ? 'خطأ' : 'تنبيه')}</p>
    <p class="text-xs">${message}</p>
</div>
`;

            container.appendChild(toast);
            lucide.createIcons();

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-enter-active');
            });

            // Auto Dismiss
            setTimeout(() => {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-exit-active');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Init ---
        if (API_URL) reloadSchoolsAndLogin();
        else render();
    </script>
</body>

</html>